# æ™ºèƒ½èŠå¤©æœºå™¨äººç³»ç»Ÿ - æœ¬åœ°å¼€å‘ Makefile

.PHONY: help setup up down restart logs clean build health check-deps

# é»˜è®¤ç›®æ ‡
.DEFAULT_GOAL := help

# é¢œè‰²å®šä¹‰
BLUE := \033[36m
GREEN := \033[32m
YELLOW := \033[33m
RED := \033[31m
NC := \033[0m

## æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
help:
	@echo "$(BLUE)æ™ºèƒ½èŠå¤©æœºå™¨äººç³»ç»Ÿ - æœ¬åœ°å¼€å‘å‘½ä»¤$(NC)"
	@echo "=================================================="
	@echo
	@echo "$(GREEN)ğŸš€ éƒ¨ç½²å‘½ä»¤:$(NC)"
	@echo "  $(YELLOW)make setup$(NC)     - å®Œæ•´éƒ¨ç½²ï¼ˆåŒ…å«ä¾èµ–æ£€æŸ¥ã€æ„å»ºã€å¯åŠ¨ï¼‰"
	@echo "  $(YELLOW)make up$(NC)        - å¯åŠ¨æ‰€æœ‰æœåŠ¡"
	@echo "  $(YELLOW)make down$(NC)      - åœæ­¢æ‰€æœ‰æœåŠ¡"
	@echo "  $(YELLOW)make restart$(NC)   - é‡å¯æ‰€æœ‰æœåŠ¡"
	@echo
	@echo "$(GREEN)ğŸ”§ å¼€å‘å‘½ä»¤:$(NC)"
	@echo "  $(YELLOW)make build$(NC)     - æ„å»ºåº”ç”¨é•œåƒ"
	@echo "  $(YELLOW)make logs$(NC)      - æŸ¥çœ‹æ‰€æœ‰æœåŠ¡æ—¥å¿—"
	@echo "  $(YELLOW)make logs-f$(NC)    - å®æ—¶æŸ¥çœ‹æœåŠ¡æ—¥å¿—"
	@echo "  $(YELLOW)make health$(NC)    - å¥åº·æ£€æŸ¥"
	@echo
	@echo "$(GREEN)ğŸ—„ï¸ æ•°æ®åº“å‘½ä»¤:$(NC)"
	@echo "  $(YELLOW)make db-init$(NC)   - åˆå§‹åŒ–æ•°æ®åº“"
	@echo "  $(YELLOW)make db-reset$(NC)  - é‡ç½®æ•°æ®åº“"
	@echo "  $(YELLOW)make db-backup$(NC) - å¤‡ä»½æ•°æ®åº“"
	@echo
	@echo "$(GREEN)ğŸ§¹ æ¸…ç†å‘½ä»¤:$(NC)"
	@echo "  $(YELLOW)make clean$(NC)     - æ¸…ç†å®¹å™¨å’Œç½‘ç»œ"
	@echo "  $(YELLOW)make clean-all$(NC) - æ¸…ç†æ‰€æœ‰ï¼ˆåŒ…å«æ•°æ®å·ï¼‰"
	@echo
	@echo "$(GREEN)ğŸ“Š ç›‘æ§å‘½ä»¤:$(NC)"
	@echo "  $(YELLOW)make monitor$(NC)   - æ‰“å¼€ç›‘æ§é¢æ¿"
	@echo "  $(YELLOW)make status$(NC)    - æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
	@echo

## æ£€æŸ¥ä¾èµ–
check-deps:
	@echo "$(BLUE)æ£€æŸ¥ç³»ç»Ÿä¾èµ–...$(NC)"
	@command -v docker >/dev/null 2>&1 || { echo "$(RED)é”™è¯¯: Docker æœªå®‰è£…$(NC)"; exit 1; }
	@command -v docker-compose >/dev/null 2>&1 || docker compose version >/dev/null 2>&1 || { echo "$(RED)é”™è¯¯: Docker Compose æœªå®‰è£…$(NC)"; exit 1; }
	@echo "$(GREEN)âœ“ ä¾èµ–æ£€æŸ¥é€šè¿‡$(NC)"

## å®Œæ•´éƒ¨ç½²
setup: check-deps
	@echo "$(BLUE)å¼€å§‹å®Œæ•´éƒ¨ç½²...$(NC)"
	@./deploy.sh
	@echo "$(GREEN)âœ“ éƒ¨ç½²å®Œæˆ$(NC)"

## å¯åŠ¨æ‰€æœ‰æœåŠ¡
up:
	@echo "$(BLUE)å¯åŠ¨æ‰€æœ‰æœåŠ¡...$(NC)"
	@docker-compose -f docker-compose.local.yml up -d
	@echo "$(GREEN)âœ“ æœåŠ¡å¯åŠ¨å®Œæˆ$(NC)"
	@make status

## åœæ­¢æ‰€æœ‰æœåŠ¡
down:
	@echo "$(BLUE)åœæ­¢æ‰€æœ‰æœåŠ¡...$(NC)"
	@docker-compose -f docker-compose.local.yml down
	@echo "$(GREEN)âœ“ æœåŠ¡å·²åœæ­¢$(NC)"

## é‡å¯æ‰€æœ‰æœåŠ¡
restart: down
	@echo "$(BLUE)é‡å¯æ‰€æœ‰æœåŠ¡...$(NC)"
	@sleep 2
	@make up

## æ„å»ºåº”ç”¨é•œåƒ
build:
	@echo "$(BLUE)æ„å»ºåº”ç”¨é•œåƒ...$(NC)"
	@if [ -f "backend/Dockerfile" ]; then \
		echo "æ„å»º Gateway é•œåƒ..."; \
		docker build -t chatbot-gateway:latest ./backend; \
	fi
	@if [ -f "algo/Dockerfile" ]; then \
		echo "æ„å»º Algorithm é•œåƒ..."; \
		docker build -t chatbot-algo:latest ./algo; \
	fi
	@if [ -f "frontend/Dockerfile" ]; then \
		echo "æ„å»º Frontend é•œåƒ..."; \
		docker build -t chatbot-frontend:latest ./frontend; \
	fi
	@if [ -f "admin/Dockerfile" ]; then \
		echo "æ„å»º Admin é•œåƒ..."; \
		docker build -t chatbot-admin:latest ./admin; \
	fi
	@echo "$(GREEN)âœ“ é•œåƒæ„å»ºå®Œæˆ$(NC)"

## æŸ¥çœ‹æœåŠ¡æ—¥å¿—
logs:
	@docker-compose -f docker-compose.local.yml logs

## å®æ—¶æŸ¥çœ‹æœåŠ¡æ—¥å¿—
logs-f:
	@docker-compose -f docker-compose.local.yml logs -f

## æŸ¥çœ‹ç‰¹å®šæœåŠ¡æ—¥å¿—
logs-%:
	@docker-compose -f docker-compose.local.yml logs -f $*

## å¥åº·æ£€æŸ¥
health:
	@echo "$(BLUE)æ‰§è¡Œå¥åº·æ£€æŸ¥...$(NC)"
	@echo
	@echo "$(YELLOW)å®¹å™¨çŠ¶æ€:$(NC)"
	@docker-compose -f docker-compose.local.yml ps
	@echo
	@echo "$(YELLOW)ç«¯å£æ£€æŸ¥:$(NC)"
	@services="PostgreSQL:5432 Redis:6379 Milvus:19530 Neo4j:7474 Prometheus:9090 Grafana:3001 Elasticsearch:9200 Kibana:5601 RabbitMQ:15672"; \
	for service in $$services; do \
		name=$$(echo $$service | cut -d: -f1); \
		port=$$(echo $$service | cut -d: -f2); \
		if nc -z localhost $$port 2>/dev/null; then \
			echo "  $(GREEN)âœ“$(NC) $$name ($$port)"; \
		else \
			echo "  $(RED)âœ—$(NC) $$name ($$port)"; \
		fi; \
	done

## æŸ¥çœ‹æœåŠ¡çŠ¶æ€
status:
	@echo "$(BLUE)æœåŠ¡çŠ¶æ€æ¦‚è§ˆ:$(NC)"
	@docker-compose -f docker-compose.local.yml ps --format "table {{.Name}}\t{{.Status}}\t{{.Ports}}"

## åˆå§‹åŒ–æ•°æ®åº“
db-init:
	@echo "$(BLUE)åˆå§‹åŒ–æ•°æ®åº“...$(NC)"
	@if [ -f "deploy/database/schema.sql" ]; then \
		docker exec -i chatbot-postgres psql -U chatbot -d chatbot < deploy/database/schema.sql; \
		echo "$(GREEN)âœ“ æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ$(NC)"; \
	else \
		echo "$(YELLOW)âš  æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬ä¸å­˜åœ¨$(NC)"; \
	fi

## é‡ç½®æ•°æ®åº“
db-reset:
	@echo "$(BLUE)é‡ç½®æ•°æ®åº“...$(NC)"
	@docker exec chatbot-postgres psql -U chatbot -d chatbot -c "DROP SCHEMA public CASCADE; CREATE SCHEMA public;"
	@make db-init
	@echo "$(GREEN)âœ“ æ•°æ®åº“é‡ç½®å®Œæˆ$(NC)"

## å¤‡ä»½æ•°æ®åº“
db-backup:
	@echo "$(BLUE)å¤‡ä»½æ•°æ®åº“...$(NC)"
	@mkdir -p backups
	@docker exec chatbot-postgres pg_dump -U chatbot chatbot > backups/chatbot_$$(date +%Y%m%d_%H%M%S).sql
	@echo "$(GREEN)âœ“ æ•°æ®åº“å¤‡ä»½å®Œæˆ$(NC)"

## æ¸…ç†å®¹å™¨å’Œç½‘ç»œ
clean:
	@echo "$(BLUE)æ¸…ç†å®¹å™¨å’Œç½‘ç»œ...$(NC)"
	@docker-compose -f docker-compose.local.yml down --remove-orphans
	@docker network prune -f
	@echo "$(GREEN)âœ“ æ¸…ç†å®Œæˆ$(NC)"

## æ¸…ç†æ‰€æœ‰ï¼ˆåŒ…å«æ•°æ®å·ï¼‰
clean-all:
	@echo "$(RED)âš  è¿™å°†åˆ é™¤æ‰€æœ‰æ•°æ®ï¼ŒåŒ…æ‹¬æ•°æ®åº“æ•°æ®ï¼$(NC)"
	@read -p "ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ(y/N) " confirm && [ "$$confirm" = "y" ]
	@docker-compose -f docker-compose.local.yml down -v --remove-orphans
	@docker system prune -f
	@echo "$(GREEN)âœ“ å®Œå…¨æ¸…ç†å®Œæˆ$(NC)"

## æ‰“å¼€ç›‘æ§é¢æ¿
monitor:
	@echo "$(BLUE)æ‰“å¼€ç›‘æ§é¢æ¿...$(NC)"
	@echo "Prometheus: http://localhost:9090"
	@echo "Grafana:    http://localhost:3001 (admin/admin123)"
	@echo "Kibana:     http://localhost:5601"
	@echo "RabbitMQ:   http://localhost:15672 (rabbitmq/rabbitmq123)"
	@if command -v open >/dev/null 2>&1; then \
		open http://localhost:3001; \
	elif command -v xdg-open >/dev/null 2>&1; then \
		xdg-open http://localhost:3001; \
	fi

## è¿›å…¥å®¹å™¨
shell-%:
	@docker exec -it chatbot-$* /bin/bash || docker exec -it chatbot-$* /bin/sh

## æŸ¥çœ‹èµ„æºä½¿ç”¨æƒ…å†µ
stats:
	@echo "$(BLUE)èµ„æºä½¿ç”¨æƒ…å†µ:$(NC)"
	@docker stats --no-stream --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}\t{{.NetIO}}\t{{.BlockIO}}"

## æ›´æ–°é•œåƒ
update:
	@echo "$(BLUE)æ›´æ–°åŸºç¡€é•œåƒ...$(NC)"
	@docker-compose -f docker-compose.local.yml pull
	@echo "$(GREEN)âœ“ é•œåƒæ›´æ–°å®Œæˆ$(NC)"

## å¿«é€Ÿé‡å»º
rebuild: clean build up

## å¼€å‘æ¨¡å¼ï¼ˆä»…å¯åŠ¨åŸºç¡€è®¾æ–½ï¼‰
dev:
	@echo "$(BLUE)å¯åŠ¨å¼€å‘æ¨¡å¼ï¼ˆä»…åŸºç¡€è®¾æ–½ï¼‰...$(NC)"
	@docker-compose -f docker-compose.local.yml up -d postgres redis milvus neo4j prometheus grafana elasticsearch rabbitmq
	@echo "$(GREEN)âœ“ å¼€å‘ç¯å¢ƒå°±ç»ª$(NC)"
	@make status
