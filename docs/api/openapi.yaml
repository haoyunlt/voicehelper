openapi: 3.0.3
info:
  title: Chatbot API
  description: |
    æ™ºèƒ½èŠå¤©æœºå™¨äººç³»ç»ŸAPIæ–‡æ¡£
    
    ## åŠŸèƒ½ç‰¹æ€§
    - ğŸ¤– æ™ºèƒ½å¯¹è¯ï¼šæ”¯æŒæ–‡æœ¬å’Œè¯­éŸ³åŒæ¨¡æ€äº¤äº’
    - ğŸ“š çŸ¥è¯†æ£€ç´¢ï¼šåŸºäºGraphRAGçš„æ™ºèƒ½æ–‡æ¡£æ£€ç´¢
    - ğŸ‘¥ å¤šç§Ÿæˆ·ï¼šæ”¯æŒå¤šç§Ÿæˆ·éš”ç¦»å’Œç®¡ç†
    - ğŸ” å®‰å…¨è®¤è¯ï¼šJWTä»¤ç‰Œè®¤è¯å’ŒRBACæƒé™æ§åˆ¶
    - ğŸ“Š ç›‘æ§æŒ‡æ ‡ï¼šå®Œæ•´çš„æ€§èƒ½å’Œä¸šåŠ¡æŒ‡æ ‡ç›‘æ§
    
    ## è®¤è¯æ–¹å¼
    APIä½¿ç”¨JWT Bearer Tokenè¿›è¡Œè®¤è¯ã€‚è¯·åœ¨è¯·æ±‚å¤´ä¸­åŒ…å«ï¼š
    ```
    Authorization: Bearer <your-jwt-token>
    ```
    
  version: 1.6.0
  contact:
    name: Chatbot API Support
    email: support@chatbot.ai
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: https://api.chatbot.ai/v1
    description: ç”Ÿäº§ç¯å¢ƒ
  - url: https://staging-api.chatbot.ai/v1
    description: æµ‹è¯•ç¯å¢ƒ
  - url: http://localhost:8080/v1
    description: æœ¬åœ°å¼€å‘ç¯å¢ƒ

security:
  - BearerAuth: []

paths:
  # è®¤è¯ç›¸å…³
  /auth/wechat/login:
    post:
      tags:
        - Authentication
      summary: å¾®ä¿¡å°ç¨‹åºç™»å½•
      description: ä½¿ç”¨å¾®ä¿¡å°ç¨‹åºæˆæƒç è¿›è¡Œç™»å½•
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WeChatLoginRequest'
      responses:
        '200':
          description: ç™»å½•æˆåŠŸ
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /auth/refresh:
    post:
      tags:
        - Authentication
      summary: åˆ·æ–°è®¿é—®ä»¤ç‰Œ
      description: ä½¿ç”¨åˆ·æ–°ä»¤ç‰Œè·å–æ–°çš„è®¿é—®ä»¤ç‰Œ
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                refresh_token:
                  type: string
                  description: åˆ·æ–°ä»¤ç‰Œ
              required:
                - refresh_token
      responses:
        '200':
          description: åˆ·æ–°æˆåŠŸ
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'

  # å¯¹è¯ç›¸å…³
  /conversations:
    get:
      tags:
        - Conversations
      summary: è·å–å¯¹è¯åˆ—è¡¨
      description: è·å–å½“å‰ç”¨æˆ·çš„å¯¹è¯åˆ—è¡¨
      parameters:
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/LimitParam'
        - name: status
          in: query
          description: å¯¹è¯çŠ¶æ€ç­›é€‰
          schema:
            type: string
            enum: [active, archived, deleted]
      responses:
        '200':
          description: è·å–æˆåŠŸ
          content:
            application/json:
              schema:
                type: object
                properties:
                  conversations:
                    type: array
                    items:
                      $ref: '#/components/schemas/Conversation'
                  pagination:
                    $ref: '#/components/schemas/Pagination'

    post:
      tags:
        - Conversations
      summary: åˆ›å»ºæ–°å¯¹è¯
      description: åˆ›å»ºä¸€ä¸ªæ–°çš„å¯¹è¯ä¼šè¯
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                title:
                  type: string
                  description: å¯¹è¯æ ‡é¢˜
                  maxLength: 100
                metadata:
                  type: object
                  description: å¯¹è¯å…ƒæ•°æ®
              example:
                title: "æ–°çš„å¯¹è¯"
                metadata:
                  source: "web"
      responses:
        '201':
          description: åˆ›å»ºæˆåŠŸ
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Conversation'

  /conversations/{conversationId}:
    get:
      tags:
        - Conversations
      summary: è·å–å¯¹è¯è¯¦æƒ…
      description: è·å–æŒ‡å®šå¯¹è¯çš„è¯¦ç»†ä¿¡æ¯
      parameters:
        - $ref: '#/components/parameters/ConversationIdParam'
      responses:
        '200':
          description: è·å–æˆåŠŸ
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Conversation'
        '404':
          $ref: '#/components/responses/NotFound'

    put:
      tags:
        - Conversations
      summary: æ›´æ–°å¯¹è¯
      description: æ›´æ–°å¯¹è¯çš„æ ‡é¢˜æˆ–å…ƒæ•°æ®
      parameters:
        - $ref: '#/components/parameters/ConversationIdParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                title:
                  type: string
                  maxLength: 100
                metadata:
                  type: object
      responses:
        '200':
          description: æ›´æ–°æˆåŠŸ
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Conversation'

    delete:
      tags:
        - Conversations
      summary: åˆ é™¤å¯¹è¯
      description: è½¯åˆ é™¤æŒ‡å®šçš„å¯¹è¯
      parameters:
        - $ref: '#/components/parameters/ConversationIdParam'
      responses:
        '204':
          description: åˆ é™¤æˆåŠŸ

  /conversations/{conversationId}/messages:
    get:
      tags:
        - Messages
      summary: è·å–å¯¹è¯æ¶ˆæ¯
      description: è·å–æŒ‡å®šå¯¹è¯çš„æ¶ˆæ¯åˆ—è¡¨
      parameters:
        - $ref: '#/components/parameters/ConversationIdParam'
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/LimitParam'
        - name: before
          in: query
          description: è·å–æŒ‡å®šæ—¶é—´ä¹‹å‰çš„æ¶ˆæ¯
          schema:
            type: string
            format: date-time
      responses:
        '200':
          description: è·å–æˆåŠŸ
          content:
            application/json:
              schema:
                type: object
                properties:
                  messages:
                    type: array
                    items:
                      $ref: '#/components/schemas/Message'
                  pagination:
                    $ref: '#/components/schemas/Pagination'

    post:
      tags:
        - Messages
      summary: å‘é€æ¶ˆæ¯
      description: å‘æŒ‡å®šå¯¹è¯å‘é€æ¶ˆæ¯
      parameters:
        - $ref: '#/components/parameters/ConversationIdParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SendMessageRequest'
      responses:
        '200':
          description: æ¶ˆæ¯å‘é€æˆåŠŸï¼Œè¿”å›AIå›å¤
          content:
            text/event-stream:
              schema:
                type: string
                description: Server-Sent Eventsæµå¼å“åº”
              example: |
                data: {"type": "delta", "content": "ä½ å¥½", "seq": 1}
                
                data: {"type": "delta", "content": "ï¼æˆ‘æ˜¯", "seq": 2}
                
                data: {"type": "delta", "content": "AIåŠ©æ‰‹", "seq": 3}
                
                data: {"type": "done", "message_id": "msg_123", "seq": 4}

  # è¯­éŸ³ç›¸å…³
  /voice/transcribe:
    post:
      tags:
        - Voice
      summary: è¯­éŸ³è½¬æ–‡å­—
      description: å°†éŸ³é¢‘æ–‡ä»¶è½¬æ¢ä¸ºæ–‡å­—
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                audio:
                  type: string
                  format: binary
                  description: éŸ³é¢‘æ–‡ä»¶ (æ”¯æŒ wav, mp3, m4a)
                language:
                  type: string
                  description: è¯­è¨€ä»£ç 
                  default: "zh-CN"
                  enum: ["zh-CN", "en-US", "ja-JP"]
              required:
                - audio
      responses:
        '200':
          description: è½¬æ¢æˆåŠŸ
          content:
            application/json:
              schema:
                type: object
                properties:
                  text:
                    type: string
                    description: è¯†åˆ«å‡ºçš„æ–‡å­—
                  confidence:
                    type: number
                    format: float
                    description: ç½®ä¿¡åº¦ (0-1)
                  duration:
                    type: number
                    format: float
                    description: éŸ³é¢‘æ—¶é•¿(ç§’)

  /voice/synthesize:
    post:
      tags:
        - Voice
      summary: æ–‡å­—è½¬è¯­éŸ³
      description: å°†æ–‡å­—è½¬æ¢ä¸ºè¯­éŸ³
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                text:
                  type: string
                  description: è¦è½¬æ¢çš„æ–‡å­—
                  maxLength: 1000
                voice:
                  type: string
                  description: è¯­éŸ³ç±»å‹
                  default: "female"
                  enum: ["female", "male", "child"]
                speed:
                  type: number
                  format: float
                  description: è¯­é€Ÿ (0.5-2.0)
                  default: 1.0
                  minimum: 0.5
                  maximum: 2.0
              required:
                - text
      responses:
        '200':
          description: è½¬æ¢æˆåŠŸ
          content:
            audio/wav:
              schema:
                type: string
                format: binary

  # æ•°æ®é›†ç®¡ç†
  /datasets:
    get:
      tags:
        - Datasets
      summary: è·å–æ•°æ®é›†åˆ—è¡¨
      description: è·å–å½“å‰ç§Ÿæˆ·çš„æ•°æ®é›†åˆ—è¡¨
      parameters:
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/LimitParam'
      responses:
        '200':
          description: è·å–æˆåŠŸ
          content:
            application/json:
              schema:
                type: object
                properties:
                  datasets:
                    type: array
                    items:
                      $ref: '#/components/schemas/Dataset'
                  pagination:
                    $ref: '#/components/schemas/Pagination'

    post:
      tags:
        - Datasets
      summary: åˆ›å»ºæ•°æ®é›†
      description: åˆ›å»ºæ–°çš„çŸ¥è¯†æ•°æ®é›†
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  description: æ•°æ®é›†åç§°
                  maxLength: 100
                description:
                  type: string
                  description: æ•°æ®é›†æè¿°
                  maxLength: 500
                type:
                  type: string
                  description: æ•°æ®é›†ç±»å‹
                  enum: ["document", "qa", "custom"]
                  default: "document"
              required:
                - name
      responses:
        '201':
          description: åˆ›å»ºæˆåŠŸ
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Dataset'

  /datasets/{datasetId}/documents:
    post:
      tags:
        - Documents
      summary: ä¸Šä¼ æ–‡æ¡£
      description: å‘æ•°æ®é›†ä¸Šä¼ æ–‡æ¡£
      parameters:
        - name: datasetId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
                  description: æ–‡æ¡£æ–‡ä»¶
                name:
                  type: string
                  description: æ–‡æ¡£åç§°
              required:
                - file
      responses:
        '201':
          description: ä¸Šä¼ æˆåŠŸ
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Document'

  # æœç´¢ç›¸å…³
  /search:
    post:
      tags:
        - Search
      summary: çŸ¥è¯†æœç´¢
      description: åœ¨çŸ¥è¯†åº“ä¸­æœç´¢ç›¸å…³å†…å®¹
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                query:
                  type: string
                  description: æœç´¢æŸ¥è¯¢
                  maxLength: 500
                dataset_ids:
                  type: array
                  items:
                    type: string
                  description: æŒ‡å®šæœç´¢çš„æ•°æ®é›†ID
                top_k:
                  type: integer
                  description: è¿”å›ç»“æœæ•°é‡
                  default: 10
                  minimum: 1
                  maximum: 50
                threshold:
                  type: number
                  format: float
                  description: ç›¸ä¼¼åº¦é˜ˆå€¼
                  default: 0.7
                  minimum: 0.0
                  maximum: 1.0
              required:
                - query
      responses:
        '200':
          description: æœç´¢æˆåŠŸ
          content:
            application/json:
              schema:
                type: object
                properties:
                  results:
                    type: array
                    items:
                      $ref: '#/components/schemas/SearchResult'
                  total:
                    type: integer
                    description: æ€»ç»“æœæ•°

  # å¥åº·æ£€æŸ¥
  /health:
    get:
      tags:
        - System
      summary: å¥åº·æ£€æŸ¥
      description: æ£€æŸ¥ç³»ç»Ÿå¥åº·çŠ¶æ€
      security: []
      responses:
        '200':
          description: ç³»ç»Ÿå¥åº·
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [healthy, unhealthy]
                  timestamp:
                    type: integer
                    format: int64
                  service:
                    type: string
                  version:
                    type: string

  /metrics:
    get:
      tags:
        - System
      summary: ç³»ç»ŸæŒ‡æ ‡
      description: è·å–Prometheusæ ¼å¼çš„ç³»ç»ŸæŒ‡æ ‡
      security: []
      responses:
        '200':
          description: æŒ‡æ ‡æ•°æ®
          content:
            text/plain:
              schema:
                type: string

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  parameters:
    ConversationIdParam:
      name: conversationId
      in: path
      required: true
      description: å¯¹è¯ID
      schema:
        type: string
        format: uuid

    PageParam:
      name: page
      in: query
      description: é¡µç  (ä»1å¼€å§‹)
      schema:
        type: integer
        minimum: 1
        default: 1

    LimitParam:
      name: limit
      in: query
      description: æ¯é¡µæ•°é‡
      schema:
        type: integer
        minimum: 1
        maximum: 100
        default: 20

  schemas:
    WeChatLoginRequest:
      type: object
      properties:
        code:
          type: string
          description: å¾®ä¿¡æˆæƒç 
        nickname:
          type: string
          description: ç”¨æˆ·æ˜µç§°
        avatar:
          type: string
          format: uri
          description: ç”¨æˆ·å¤´åƒURL
      required:
        - code

    LoginResponse:
      type: object
      properties:
        token:
          type: string
          description: è®¿é—®ä»¤ç‰Œ
        refresh_token:
          type: string
          description: åˆ·æ–°ä»¤ç‰Œ
        expires_at:
          type: string
          format: date-time
          description: ä»¤ç‰Œè¿‡æœŸæ—¶é—´
        user:
          $ref: '#/components/schemas/User'

    TokenResponse:
      type: object
      properties:
        token:
          type: string
          description: æ–°çš„è®¿é—®ä»¤ç‰Œ
        expires_at:
          type: string
          format: date-time
          description: ä»¤ç‰Œè¿‡æœŸæ—¶é—´

    User:
      type: object
      properties:
        id:
          type: string
          format: uuid
        nickname:
          type: string
        avatar:
          type: string
          format: uri
        created_at:
          type: string
          format: date-time
        last_login:
          type: string
          format: date-time

    Conversation:
      type: object
      properties:
        id:
          type: string
          format: uuid
        title:
          type: string
        summary:
          type: string
        status:
          type: string
          enum: [active, archived, deleted]
        msg_count:
          type: integer
        token_count:
          type: integer
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        last_msg_at:
          type: string
          format: date-time
        metadata:
          type: object

    Message:
      type: object
      properties:
        id:
          type: string
          format: uuid
        conversation_id:
          type: string
          format: uuid
        role:
          type: string
          enum: [user, assistant, system]
        content:
          type: string
        modality:
          type: string
          enum: [text, voice, image]
        token_count:
          type: integer
        references:
          type: array
          items:
            $ref: '#/components/schemas/Reference'
        created_at:
          type: string
          format: date-time
        metadata:
          type: object

    SendMessageRequest:
      type: object
      properties:
        content:
          type: string
          description: æ¶ˆæ¯å†…å®¹
          maxLength: 4000
        modality:
          type: string
          enum: [text, voice]
          default: text
        stream:
          type: boolean
          description: æ˜¯å¦æµå¼è¿”å›
          default: true
        metadata:
          type: object
          description: æ¶ˆæ¯å…ƒæ•°æ®
      required:
        - content

    Reference:
      type: object
      properties:
        title:
          type: string
        url:
          type: string
          format: uri
        snippet:
          type: string
        score:
          type: number
          format: float

    Dataset:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        description:
          type: string
        type:
          type: string
          enum: [document, qa, custom]
        status:
          type: string
          enum: [active, inactive, processing]
        doc_count:
          type: integer
        chunk_count:
          type: integer
        token_count:
          type: integer
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    Document:
      type: object
      properties:
        id:
          type: string
          format: uuid
        dataset_id:
          type: string
          format: uuid
        name:
          type: string
        source:
          type: string
        type:
          type: string
        size:
          type: integer
          format: int64
        status:
          type: string
          enum: [pending, processing, completed, failed]
        chunk_count:
          type: integer
        token_count:
          type: integer
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    SearchResult:
      type: object
      properties:
        content:
          type: string
        score:
          type: number
          format: float
        source:
          type: object
          properties:
            document_id:
              type: string
            document_name:
              type: string
            chunk_id:
              type: string
        metadata:
          type: object

    Pagination:
      type: object
      properties:
        page:
          type: integer
        limit:
          type: integer
        total:
          type: integer
        pages:
          type: integer

    Error:
      type: object
      properties:
        error:
          type: string
          description: é”™è¯¯æ¶ˆæ¯
        code:
          type: string
          description: é”™è¯¯ä»£ç 
        details:
          type: object
          description: é”™è¯¯è¯¦æƒ…

  responses:
    BadRequest:
      description: è¯·æ±‚å‚æ•°é”™è¯¯
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "Invalid request parameters"
            code: "INVALID_PARAMS"

    Unauthorized:
      description: æœªæˆæƒè®¿é—®
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "Unauthorized access"
            code: "UNAUTHORIZED"

    Forbidden:
      description: æƒé™ä¸è¶³
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "Insufficient permissions"
            code: "FORBIDDEN"

    NotFound:
      description: èµ„æºä¸å­˜åœ¨
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "Resource not found"
            code: "NOT_FOUND"

    InternalServerError:
      description: æœåŠ¡å™¨å†…éƒ¨é”™è¯¯
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "Internal server error"
            code: "INTERNAL_ERROR"

tags:
  - name: Authentication
    description: ç”¨æˆ·è®¤è¯ç›¸å…³æ¥å£
  - name: Conversations
    description: å¯¹è¯ç®¡ç†æ¥å£
  - name: Messages
    description: æ¶ˆæ¯å¤„ç†æ¥å£
  - name: Voice
    description: è¯­éŸ³å¤„ç†æ¥å£
  - name: Datasets
    description: æ•°æ®é›†ç®¡ç†æ¥å£
  - name: Documents
    description: æ–‡æ¡£ç®¡ç†æ¥å£
  - name: Search
    description: çŸ¥è¯†æœç´¢æ¥å£
  - name: System
    description: ç³»ç»Ÿç›¸å…³æ¥å£
