# VoiceHelper å¼‚å¸¸å¤„ç†å®Œå–„æ€»ç»“

## ğŸ“‹ å®Œå–„å†…å®¹æ¦‚è§ˆ

æœ¬æ¬¡å¼‚å¸¸å¤„ç†å®Œå–„å·¥ä½œç¡®ä¿äº†æ‰€æœ‰æŠ¥é”™çš„åœ°æ–¹éƒ½è¿”å›ç»Ÿä¸€çš„é”™è¯¯ç å¹¶æ‰“å°è¯¦ç»†çš„é”™è¯¯æ—¥å¿—ï¼Œæå‡äº†ç³»ç»Ÿçš„å¯ç»´æŠ¤æ€§å’Œé—®é¢˜æ’æŸ¥æ•ˆç‡ã€‚

## âœ… å·²å®Œå–„çš„æ¨¡å—

### 1. ç»Ÿä¸€é”™è¯¯ç ç³»ç»Ÿ

#### ğŸ“ `backend/pkg/errors/error_codes.go`
- **å®Œæ•´çš„é”™è¯¯ç å®šä¹‰**: æ¶µç›–ç³»ç»Ÿçº§ã€ä¸šåŠ¡çº§ã€ç¬¬ä¸‰æ–¹æœåŠ¡ç­‰å„ç±»é”™è¯¯
- **é”™è¯¯ç åˆ†ç±»**:
  - é€šç”¨é”™è¯¯: `INTERNAL_SERVER_ERROR`, `INVALID_PARAMS`, `UNAUTHORIZED` ç­‰
  - å¾®ä¿¡ç™»å½•: `WECHAT_LOGIN_FAILED`, `WECHAT_CODE_INVALID`, `SIGNATURE_INVALID` ç­‰
  - ç”¨æˆ·ç®¡ç†: `USER_NOT_FOUND`, `USER_CREATE_FAILED`, `USER_UPDATE_FAILED` ç­‰
  - èŠå¤©ç›¸å…³: `CHAT_SESSION_NOT_FOUND`, `CHAT_CANCEL_FAILED` ç­‰
  - è¯­éŸ³å¤„ç†: `VOICE_FILE_INVALID`, `VOICE_TRANSCRIBE_FAILED` ç­‰
  - æ•°æ®åº“æ“ä½œ: `DATABASE_CONNECTION_ERROR`, `DATABASE_QUERY_ERROR` ç­‰

#### ğŸ“ `backend/pkg/middleware/error_handler.go`
- **å…¨å±€é”™è¯¯å¤„ç†ä¸­é—´ä»¶**: ç»Ÿä¸€çš„é”™è¯¯å“åº”æ ¼å¼
- **Panicæ¢å¤æœºåˆ¶**: è‡ªåŠ¨æ•è·å’Œè®°å½•ç³»ç»Ÿpanic
- **è¯·æ±‚è¶…æ—¶å¤„ç†**: é˜²æ­¢é•¿æ—¶é—´é˜»å¡
- **å‚æ•°éªŒè¯é”™è¯¯å¤„ç†**: ç»Ÿä¸€çš„å‚æ•°ç»‘å®šé”™è¯¯å¤„ç†

### 2. å¾®ä¿¡å°ç¨‹åºç™»å½•å¼‚å¸¸å¤„ç†

#### ğŸ“ `backend/internal/handlers/api_routes.go`
**å®Œå–„çš„å¾®ä¿¡ç™»å½•æµç¨‹å¼‚å¸¸å¤„ç†**:

```go
// 1. å‚æ•°ç»‘å®šå¼‚å¸¸
if err := c.ShouldBindJSON(&req); err != nil {
    logrus.WithFields(logrus.Fields{
        "error":      err.Error(),
        "request_id": c.GetString("request_id"),
        "path":       c.Request.URL.Path,
    }).Error("å¾®ä¿¡ç™»å½•è¯·æ±‚å‚æ•°ç»‘å®šå¤±è´¥")
    
    apiErr := errors.NewAPIErrorWithCause(
        errors.ErrInvalidParams,
        "è¯·æ±‚å‚æ•°æ ¼å¼é”™è¯¯",
        http.StatusBadRequest,
        err,
    )
    middleware.HandleAPIError(c, apiErr)
    return
}

// 2. Code2Sessionå¼‚å¸¸
if err != nil {
    logrus.WithFields(logrus.Fields{
        "error":      err.Error(),
        "request_id": c.GetString("request_id"),
        "code":       req.Code[:8] + "...",
        "tenant_id":  req.TenantID,
    }).Error("å¾®ä¿¡Code2Sessionè°ƒç”¨å¤±è´¥")
    
    apiErr := errors.NewAPIErrorWithCause(
        errors.ErrWechatLoginFailed,
        "å¾®ä¿¡æˆæƒéªŒè¯å¤±è´¥",
        http.StatusUnauthorized,
        err,
    )
    middleware.HandleAPIError(c, apiErr)
    return
}
```

#### ğŸ“ `backend/internal/handlers/wechat_user.go`
**ç”¨æˆ·ç®¡ç†å¼‚å¸¸å¤„ç†**:

```go
// æ•°æ®åº“æŸ¥è¯¢å¼‚å¸¸
if err != nil {
    if err != sql.ErrNoRows {
        logrus.WithFields(logrus.Fields{
            "error":  err.Error(),
            "openid": openID[:8] + "...",
        }).Error("æ•°æ®åº“æŸ¥è¯¢å¾®ä¿¡ç”¨æˆ·å¤±è´¥")
    }
    return nil, err
}

// ç”¨æˆ·åˆ›å»ºå¼‚å¸¸
if err := h.createWechatUser(user); err != nil {
    logrus.WithFields(logrus.Fields{
        "error":    err.Error(),
        "user_id":  user.ID,
        "openid":   sessionResp.OpenID[:8] + "...",
        "nickname": user.Nickname,
    }).Error("åˆ›å»ºå¾®ä¿¡ç”¨æˆ·å¤±è´¥")
    return nil, fmt.Errorf("åˆ›å»ºç”¨æˆ·å¤±è´¥: %w", err)
}
```

#### ğŸ“ `backend/pkg/wechat/miniprogram.go`
**å¾®ä¿¡SDKå¼‚å¸¸å¤„ç†**:

```go
// HTTPè¯·æ±‚å¼‚å¸¸
if err != nil {
    logrus.WithFields(logrus.Fields{
        "error":  err.Error(),
        "appid":  c.config.AppID,
        "code":   code[:8] + "...",
    }).Error("å¾®ä¿¡Code2Session HTTPè¯·æ±‚å¤±è´¥")
    return nil, fmt.Errorf("å¾®ä¿¡APIè¯·æ±‚å¤±è´¥: %w", err)
}

// çŠ¶æ€ç æ£€æŸ¥
if resp.StatusCode != http.StatusOK {
    logrus.WithFields(logrus.Fields{
        "status_code": resp.StatusCode,
        "appid":       c.config.AppID,
        "code":        code[:8] + "...",
    }).Error("å¾®ä¿¡Code2Session HTTPçŠ¶æ€ç å¼‚å¸¸")
    return nil, fmt.Errorf("å¾®ä¿¡APIè¿”å›å¼‚å¸¸çŠ¶æ€ç : %d", resp.StatusCode)
}

// JSONè§£æå¼‚å¸¸
if err := json.Unmarshal(body, &sessionResp); err != nil {
    logrus.WithFields(logrus.Fields{
        "error":    err.Error(),
        "appid":    c.config.AppID,
        "response": string(body)[:200] + "...",
    }).Error("è§£æå¾®ä¿¡APIå“åº”å¤±è´¥")
    return nil, fmt.Errorf("è§£æå“åº”å¤±è´¥: %w", err)
}
```

### 3. èŠå¤©åŠŸèƒ½å¼‚å¸¸å¤„ç†

#### å–æ¶ˆèŠå¤©å¼‚å¸¸å¤„ç†
```go
// å‚æ•°éªŒè¯å¼‚å¸¸
if err := c.ShouldBindJSON(&req); err != nil {
    logrus.WithFields(logrus.Fields{
        "error":      err.Error(),
        "request_id": c.GetString("request_id"),
        "path":       c.Request.URL.Path,
    }).Error("å–æ¶ˆèŠå¤©è¯·æ±‚å‚æ•°ç»‘å®šå¤±è´¥")
    
    apiErr := errors.NewAPIErrorWithCause(
        errors.ErrInvalidParams,
        "è¯·æ±‚å‚æ•°æ ¼å¼é”™è¯¯",
        http.StatusBadRequest,
        err,
    )
    middleware.HandleAPIError(c, apiErr)
    return
}

// æœåŠ¡è°ƒç”¨å¼‚å¸¸
if err != nil {
    logrus.WithFields(logrus.Fields{
        "error":      err.Error(),
        "request_id": c.GetString("request_id"),
        "stream_id":  req.StreamID,
        "user_id":    userID,
        "tenant_id":  tenantID,
    }).Error("è°ƒç”¨ç®—æ³•æœåŠ¡å–æ¶ˆèŠå¤©å¤±è´¥")
    
    apiErr := errors.NewAPIErrorWithCause(
        errors.ErrChatCancelFailed,
        "å–æ¶ˆèŠå¤©æœåŠ¡è°ƒç”¨å¤±è´¥",
        http.StatusInternalServerError,
        err,
    )
    middleware.HandleAPIError(c, apiErr)
    return
}
```

## ğŸ¯ å¼‚å¸¸å¤„ç†ç‰¹ç‚¹

### 1. ç»Ÿä¸€çš„é”™è¯¯å“åº”æ ¼å¼
```json
{
  "error": "ç”¨æˆ·å‹å¥½çš„é”™è¯¯æ¶ˆæ¯",
  "code": "SPECIFIC_ERROR_CODE",
  "details": "è¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰",
  "timestamp": "2025-09-23T10:30:00Z",
  "request_id": "req_12345",
  "path": "/api/v1/wechat/login"
}
```

### 2. ç»“æ„åŒ–æ—¥å¿—è®°å½•
```go
logrus.WithFields(logrus.Fields{
    "error":      err.Error(),
    "request_id": c.GetString("request_id"),
    "user_id":    userID,
    "tenant_id":  tenantID,
    "operation":  "specific_operation",
}).Error("è¯¦ç»†çš„é”™è¯¯æè¿°")
```

### 3. éšç§ä¿æŠ¤
- **æ•æ„Ÿä¿¡æ¯è„±æ•**: OpenIDã€Codeã€ç­¾åç­‰åªè®°å½•å‰å‡ ä½
- **æ•°æ®æˆªæ–­**: é•¿æ–‡æœ¬å†…å®¹åªè®°å½•å‰Nä¸ªå­—ç¬¦
- **å®‰å…¨æ—¥å¿—**: é¿å…åœ¨æ—¥å¿—ä¸­æš´éœ²å®Œæ•´çš„æ•æ„Ÿæ•°æ®

### 4. é”™è¯¯é“¾è¿½è¸ª
```go
apiErr := errors.NewAPIErrorWithCause(
    errors.ErrWechatLoginFailed,
    "å¾®ä¿¡æˆæƒéªŒè¯å¤±è´¥",
    http.StatusUnauthorized,
    err, // åŸå§‹é”™è¯¯
)
```

## ğŸ“Š é”™è¯¯ç åˆ†ç±»ç»Ÿè®¡

| åˆ†ç±» | é”™è¯¯ç æ•°é‡ | ä¸»è¦ç”¨é€” |
|------|------------|----------|
| é€šç”¨é”™è¯¯ | 8ä¸ª | ç³»ç»Ÿçº§åŸºç¡€é”™è¯¯ |
| è®¤è¯ç›¸å…³ | 6ä¸ª | ç”¨æˆ·è®¤è¯å’Œæˆæƒ |
| å¾®ä¿¡ç™»å½• | 4ä¸ª | å¾®ä¿¡å°ç¨‹åºç™»å½•æµç¨‹ |
| ç”¨æˆ·ç®¡ç† | 4ä¸ª | ç”¨æˆ·CRUDæ“ä½œ |
| èŠå¤©åŠŸèƒ½ | 3ä¸ª | èŠå¤©ä¼šè¯ç®¡ç† |
| è¯­éŸ³å¤„ç† | 5ä¸ª | è¯­éŸ³ç›¸å…³åŠŸèƒ½ |
| WebSocket | 3ä¸ª | å®æ—¶é€šä¿¡ |
| æ•°æ®åº“ | 3ä¸ª | æ•°æ®åº“æ“ä½œ |
| ç¼“å­˜ | 2ä¸ª | ç¼“å­˜æ“ä½œ |
| å¤–éƒ¨æœåŠ¡ | 3ä¸ª | ç¬¬ä¸‰æ–¹æœåŠ¡è°ƒç”¨ |
| æ–‡ä»¶æ“ä½œ | 4ä¸ª | æ–‡ä»¶ä¸Šä¼ ä¸‹è½½ |

**æ€»è®¡**: 45ä¸ªæ ‡å‡†åŒ–é”™è¯¯ç 

## ğŸ” æ—¥å¿—çº§åˆ«ä½¿ç”¨è§„èŒƒ

### Errorçº§åˆ«
- ç³»ç»Ÿå†…éƒ¨é”™è¯¯
- æ•°æ®åº“æ“ä½œå¤±è´¥
- ç¬¬ä¸‰æ–¹æœåŠ¡è°ƒç”¨å¤±è´¥
- ç”¨æˆ·æ•°æ®å¤„ç†å¤±è´¥

### Warnçº§åˆ«
- ä¸šåŠ¡é€»è¾‘è­¦å‘Š
- æ•°æ®éªŒè¯å¤±è´¥ï¼ˆéè‡´å‘½ï¼‰
- ç¼“å­˜æœªå‘½ä¸­
- é™çº§å¤„ç†

### Infoçº§åˆ«
- æ­£å¸¸ä¸šåŠ¡æµç¨‹
- ç”¨æˆ·æ“ä½œæˆåŠŸ
- ç³»ç»ŸçŠ¶æ€å˜æ›´

### Debugçº§åˆ«
- è¯¦ç»†çš„æ‰§è¡Œæµç¨‹
- å‚æ•°å’Œè¿”å›å€¼
- æ€§èƒ½è°ƒè¯•ä¿¡æ¯

## ğŸš€ æ€§èƒ½ä¼˜åŒ–è€ƒè™‘

### 1. æ—¥å¿—æ€§èƒ½
- ä½¿ç”¨ç»“æ„åŒ–æ—¥å¿—å‡å°‘å­—ç¬¦ä¸²æ‹¼æ¥
- å¼‚æ­¥æ—¥å¿—å†™å…¥é¿å…é˜»å¡ä¸»æµç¨‹
- æ—¥å¿—çº§åˆ«æ§åˆ¶å‡å°‘ä¸å¿…è¦çš„æ—¥å¿—

### 2. é”™è¯¯å¤„ç†æ€§èƒ½
- é¢„å®šä¹‰é”™è¯¯å¯¹è±¡å‡å°‘å†…å­˜åˆ†é…
- é”™è¯¯ç æ˜ å°„è¡¨æé«˜æŸ¥æ‰¾æ•ˆç‡
- é¿å…æ·±å±‚é”™è¯¯åŒ…è£…

### 3. ç›‘æ§é›†æˆ
- é”™è¯¯ç ç»Ÿè®¡ä¾¿äºç›‘æ§å‘Šè­¦
- ç»“æ„åŒ–æ—¥å¿—ä¾¿äºæ—¥å¿—åˆ†æ
- è¯·æ±‚IDè¿½è¸ªä¾¿äºé—®é¢˜å®šä½

## ğŸ“ˆ åç»­æ”¹è¿›å»ºè®®

### 1. é”™è¯¯ç å›½é™…åŒ–
- æ”¯æŒå¤šè¯­è¨€é”™è¯¯æ¶ˆæ¯
- æ ¹æ®è¯·æ±‚å¤´è‡ªåŠ¨é€‰æ‹©è¯­è¨€
- é”™è¯¯æ¶ˆæ¯æ¨¡æ¿åŒ–

### 2. é”™è¯¯ç»Ÿè®¡åˆ†æ
- é”™è¯¯ç é¢‘ç‡ç»Ÿè®¡
- é”™è¯¯è¶‹åŠ¿åˆ†æ
- è‡ªåŠ¨å‘Šè­¦æœºåˆ¶

### 3. ç”¨æˆ·ä½“éªŒä¼˜åŒ–
- æ›´å‹å¥½çš„é”™è¯¯æç¤º
- é”™è¯¯æ¢å¤å»ºè®®
- å®¢æˆ·ç«¯é”™è¯¯å¤„ç†æŒ‡å¯¼

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### åœ¨æ–°çš„APIä¸­ä½¿ç”¨ç»Ÿä¸€å¼‚å¸¸å¤„ç†

```go
func (h *APIHandler) newAPIEndpoint(c *gin.Context) {
    var req NewAPIRequest
    
    // 1. å‚æ•°ç»‘å®šå¼‚å¸¸å¤„ç†
    if err := c.ShouldBindJSON(&req); err != nil {
        logrus.WithFields(logrus.Fields{
            "error":      err.Error(),
            "request_id": c.GetString("request_id"),
            "path":       c.Request.URL.Path,
        }).Error("APIè¯·æ±‚å‚æ•°ç»‘å®šå¤±è´¥")
        
        apiErr := errors.NewAPIErrorWithCause(
            errors.ErrInvalidParams,
            "è¯·æ±‚å‚æ•°æ ¼å¼é”™è¯¯",
            http.StatusBadRequest,
            err,
        )
        middleware.HandleAPIError(c, apiErr)
        return
    }
    
    // 2. ä¸šåŠ¡é€»è¾‘å¼‚å¸¸å¤„ç†
    result, err := h.businessLogic(req)
    if err != nil {
        logrus.WithFields(logrus.Fields{
            "error":      err.Error(),
            "request_id": c.GetString("request_id"),
            "user_id":    c.GetString("user_id"),
        }).Error("ä¸šåŠ¡é€»è¾‘å¤„ç†å¤±è´¥")
        
        apiErr := errors.NewAPIErrorWithCause(
            errors.ErrInternalServer,
            "ä¸šåŠ¡å¤„ç†å¤±è´¥",
            http.StatusInternalServerError,
            err,
        )
        middleware.HandleAPIError(c, apiErr)
        return
    }
    
    // 3. æˆåŠŸå“åº”
    c.JSON(http.StatusOK, result)
}
```

---

*æœ€åæ›´æ–°æ—¶é—´: 2025-09-23*  
*å®Œå–„èŒƒå›´: åç«¯ç½‘å…³æœåŠ¡ã€å¾®ä¿¡ç™»å½•ã€ç”¨æˆ·ç®¡ç†ã€èŠå¤©åŠŸèƒ½*  
*ä¸‹ä¸€æ­¥: æ‰©å±•åˆ°è¯­éŸ³å¤„ç†ã€æ–‡æ¡£è§£æç­‰å…¶ä»–æ¨¡å—*
