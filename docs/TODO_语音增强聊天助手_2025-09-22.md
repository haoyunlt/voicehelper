
# TODO.md — 语音增强型聊天助手（详细勾选清单）
> 日期：2025-09-22 · 优先级：**P0=纳入MVP** / P1=次优先 / P2=后续**  
> 关键DoD阈值：文本首token<800ms；语音首响<700ms；barge-in≤150ms；RAG Recall@5≥0.85；检索P95<120ms

---

## 0) 里程碑与节奏
- [ ] **M0** 初始化：仓库/CI/compose/环境变量规范
- [ ] **M1 (MVP)**：完成所有 **P0** 任务并通过 DoD 与 CI Gate
- [ ] **M2**：补齐 **P1** 任务
- [ ] **M3+**：执行 **P2** 优化

---

## 1) 前端 Web / Next.js
### 1.1 Chat（SSE）
- [ ] **F-CHAT-01/P0** 实现 SSE 流式渲染 `delta/refs/done`
  - [ ] 解析 `text/event-stream`、合并增量
  - [ ] 首token P95 < 800ms（观测）
- [ ] **F-CHAT-02/P0** 引用展示（文档/页码/片段）
- [ ] **F-CHAT-03/P1** 断线重连 + 幂等 `request_id`
- [ ] **F-CHAT-04/P1** 取消/撤回（调用 `/chat/cancel`）
- [ ] **F-CHAT-05/P2** 富文本/文件输入联动入库

### 1.2 Voice（WS + AudioWorklet）
- [ ] **F-VOICE-01/P0** 采集：AudioWorklet 16k mono、20ms 分帧、PCM16 帧（含 `seq`）
- [ ] **F-VOICE-02/P0** 播放器：ring buffer + jitter buffer(80–120ms) + 追帧
- [ ] **F-VOICE-03/P0** barge-in：本地VAD起声→立即 `cancel` → 停播（≤150ms）
- [ ] **F-VOICE-04/P1** 背压：收到 `throttle` 自动降速，弱网提示
- [ ] **F-VOICE-05/P2** 可切换 Opus（浏览器端编码）

### 1.3 会话与可视化
- [ ] **F-UI-01/P0** 文本/语音共用会话时间线（消息/引用/工具事件）
- [ ] **F-UI-02/P1** Agent 事件可视化：`plan/step/tool_result/summary`
- [ ] **F-UI-03/P1** 延迟灯：capture→asr→llm→tts→play→e2e 移动平均
- [ ] **F-UI-04/P2** 数据集/索引状态页（文档数/维度/更新时间）

---

## 2) 微信小程序（MP）
- [ ] **WX-01/P0** 登录：`wx.login → /auth/wechat/miniprogram/login → JWT`
- [ ] **WX-02/P0** 上行：`RecorderManager.onFrameRecorded` 16k PCM 帧化 + WS 重连
- [ ] **WX-03/P0** 播放：A WebAudio 拼接；B InnerAudio 分片 URL 兜底
- [ ] **WX-04/P1** Agent 事件卡片/字幕同步
- [ ] **WX-05/P2** 域名/CDN 自检与体验版/生产版切换脚本

---

## 3) 后端网关（Go / Gin）
### 3.1 API（统一前缀 `/api/v1`）
- [ ] **GW-API-01/P0** `POST /chat/stream`（SSE：Envelope 输出）
- [ ] **GW-API-02/P0** `POST /chat/cancel`（幂等取消，级联 LLM/TTS）
- [ ] **GW-API-03/P0** `WS /voice/stream`（`start/audio/stop/cancel` ↔ `asr_partial/final/llm_delta/tts_chunk/...`）
- [ ] **GW-API-04/P1** `GET /search`、`POST /ingest/upload`、`GET /ingest/tasks/:id`
- [ ] **GW-API-05/P1** `GET /agent/stream`（SSE）

### 3.2 连接与治理
- [ ] **GW-CONN-01/P0** SSE/WS 公共封装（`StreamWriter` 抽象）、统一 Envelope（`meta+data+error`）
- [ ] **GW-CONN-02/P0** 心跳/背压：基于队列水位/CPU 下发 `throttle`
- [ ] **GW-CONN-03/P0** 鉴权与多租户：JWT/OIDC/WeChat；`X-Tenant-ID`
- [ ] **GW-CONN-04/P1** 速率限制/配额（租户/用户/通道）

### 3.3 可观测
- [ ] **GW-OBS-01/P0** Prom 指标：`ws_active_conns`、`sse_active_streams`、`ingress/egress_audio_bytes`、`barge_in_total`、`throttle_total`
- [ ] **GW-OBS-02/P0** Trace：`voice/ws_read`、`retrieval/search`、`llm/stream`、`tts/first|stream`

---

## 4) 算法服务（Python / FastAPI / LangChain + LangGraph）
### 4.1 Agent（LangGraph）与工具（LangChain Tools）
- [ ] **ALG-AG-01/P0** LangGraph 图：`Intent → (Retrieve) → Plan → ToolExec → Synthesize → TTS`（检查点/回放）
- [ ] **ALG-AG-02/P0** 事件流：`agent_plan/step/tool_result/summary`
- [ ] **ALG-AG-03/P0** 只读工具：`fetch_url`、`fs_read`、`github_read`（JSONSchema 校验 + 审计）
- [ ] **ALG-AG-04/P1** 工具安全：白名单、越权拒绝、敏感写操作二次确认

### 4.2 RAG（BGE Embedding + FAISS）
- [ ] **ALG-RAG-01/P0** BGE 嵌入：`bge-large-zh-v1.5`/`bge-m3`，Instruction 前缀、normalize=True
- [ ] **ALG-RAG-02/P0** FAISS 索引：`HNSW32,Flat`（`efConstruction=200`；查询 `efSearch=64`）
- [ ] **ALG-RAG-03/P0** 检索接口：TopK=5，返回 `{{content, score, source, id}}`；Recall@5 ≥ 0.85
- [ ] **ALG-RAG-04/P1** 入库/建索引：生成 `index.faiss + meta.json`（租户/数据集分片，热重载）
- [ ] **ALG-RAG-05/P2** 混合检索/重排（MMR、稀疏+稠密、多向量）

### 4.3 语音链路（ASR/TTS 适配器）
- [ ] **ALG-VOI-01/P0** ASR：partial/final 回调；VAD/端点参数（静默阈值/最短发声/回填）
- [ ] **ALG-VOI-02/P0** TTS：分片合成（200–400ms/块），可取消；首音 < 500ms
- [ ] **ALG-VOI-03/P1** 异常回退：ASR/TTS 失败转文本兜底

### 4.4 服务端接口（FastAPI）
- [ ] **ALG-API-01/P0** `POST /algo/v1/query/stream`（SSE）
- [ ] **ALG-API-02/P0** `WS /algo/v1/voice/stream`
- [ ] **ALG-API-03/P1** `POST /algo/v1/retrieve`、`POST /algo/v1/ingest`、`GET /algo/v1/agent/stream`
- [ ] **ALG-API-04/P1** `/reload?dataset_id=...` 热重载

### 4.5 指标
- [ ] **ALG-MET-01/P0** `retrieval_latency_seconds`、`faiss_index_load_seconds`、`embed_batch_seconds`
- [ ] **ALG-MET-02/P0** `asr_final_latency_seconds`、`tts_first_audio_seconds`、`agent_node_duration_seconds{node}`

---

## 5) 安全与多租户
- [ ] **SEC-01/P0** JWT/OIDC/WeChat；工具调用短期令牌（60–180s）
- [ ] **SEC-02/P0** 多租户隔离：请求头透传、索引/数据集分片、PG 审计表
- [ ] **SEC-03/P0** 日志脱敏：屏蔽 Token/PII；工具/检索操作审计
- [ ] **SEC-04/P1** 内容安全：Prompt 注入防护、越权检索检测

---

## 6) 可观测与告警（Prometheus / Grafana / OTel）
- [ ] **OBS-01/P0** 端到端漏斗：`capture → asr → llm → tts → play → e2e`
- [ ] **OBS-02/P0** 语音稳定：`ws_ooo_frames`、`ws_drop_frames`、`jitter_ms_p95`、`mp_ws_disconnects_total`
- [ ] **OBS-03/P0** 告警阈值：语音首响 P95>0.7s、barge-in P95>0.15s、断连异常、RAG 错误率>1%

---

## 7) DevOps 与环境
- [ ] **OPS-01/P0** 本地一键起：`docker-compose`（FAISS/PG/Redis/MinIO + 网关/算法/前端）
- [ ] **OPS-02/P0** Helm/K8s：HPA/PDB/Ingress(wss)，金丝雀发布
- [ ] **OPS-03/P0** 回滚：`helm rollback`；Feature Flags：`VOICE_MP`、`MCP_WRITE`、`AGENT_EVENTS_UI`
- [ ] **OPS-04/P1** 配置与密钥治理：ConfigMap/Secret/KMS/ExternalSecrets

---

## 8) 测试与质量门禁
- [ ] **QA-01/P0** 单测覆盖：Py ≥70%、Go ≥65%、TS ≥70%
- [ ] **QA-02/P0** 契约：OpenAPI + WS/SSE 回放；JSON Schema 校验
- [ ] **QA-03/P0** E2E：Playwright（文本/语音/打断/弱网）
- [ ] **QA-04/P0** 性能：k6 文本/语音混合；文本 P95<2.8s、语音首响<700ms、错误率<1%
- [ ] **QA-05/P1** 失败注入：ASR/TTS/索引缺失/速率限制

---

## 9) 附：执行提示
- 优先实现 **P0**；在 PR 模板中增加“DoD 勾选项”与“指标截图”。
- 每个任务都应绑定：负责人、预计耗时、依赖与回退预案。
