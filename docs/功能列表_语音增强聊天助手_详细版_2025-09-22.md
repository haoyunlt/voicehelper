
# 语音增强型聊天助手 — 详细功能列表（Consolidated Feature List）
> 日期：2025-09-22 · 适用：需求评审 / 研发拆分 / 验收对照  
> 技术基线：豆包 LLM（Ark/OpenAI-Compatible）· LangChain/LangGraph（Agent）· **BGE Embedding + FAISS**（RAG）· Go/Gin（网关）· Node.js/Next.js（Web 前端）· 微信小程序（语音入口）· Prometheus/OTel（可观测）· Dify（可选工作流）

---

## 0. 范围与优先级（P0=纳入MVP · P1=次优先 · P2=后续）
- **MVP (v1.0)**：文本/语音同会话、RAG（BGE+FAISS）、LangGraph Agent（只读工具）、SSE/WS、WeChat 登录、观测与回滚。
- **v1.1**：语音增强（背压/弱网）、知识库管理、热重载、更多 API、运营看板。
- **v1.2+**：混合检索/重排、WebRTC、工具写操作灰度、成本优化。

---

## 1) 架构与模块边界
- **客户端层**：Web（Next.js）+ 微信小程序（MP） → 只访问网关公开 API；使用 SSE（文本）/ WS（语音）。
- **网关层（Gin）**：鉴权/多租户、SSE/WS 连接、取消/背压/限流、统一 Envelope、指标与追踪；只对接算法服务。
- **算法层（Python）**：LangGraph Agent（状态机）、LangChain Tools、RAG（BGE+FAISS）、ASR/TTS 适配器、事件流；操作数据层。
- **数据层**：向量索引（FAISS 文件 + meta.json）、PG（会话/审计/配置）、Redis（缓存/配额）。
- **可选**：Dify 工作流（HTTP RAG + LLM）与 MCP 工具生态。

---

## 2) 前端（Web / Next.js）
### 2.1 Chat 文本（SSE）
- **P0** 流式渲染：支持 `delta/refs/done`，首 token < 800ms（P95）。
- **P0** 引用展示：来源文档/页码/片段，复制跳转。
- **P1** 断线重连与幂等 `request_id`，无重复渲染。
- **P1** 取消/撤回：调用 `/chat/cancel`，UI 状态一致。
- **P2** 富文本与文件上传：进入入库流程（异步）。

### 2.2 Voice 语音（WS + AudioWorklet）
- **P0** 采集：AudioWorklet 下采样 16k/mono，20ms 分帧，PCM16 二进制帧（带 `seq`）。
- **P0** 播放：ring buffer + jitter buffer（80–120ms），无缝拼接与追帧。
- **P0** barge-in：本地 VAD 触发 → 立刻 `cancel` → 停播，体验 ≤ 150ms。
- **P1** 背压：收到 `throttle` 自动降速，弱网提示。
- **P2** 可切换 Opus（省带宽）。

### 2.3 会话与可视化
- **P0** 文本/语音共用会话时间线；消息/引用/工具事件结构化呈现。
- **P1** Agent 事件可视化：`plan/step/tool_result/summary`。
- **P1** 延迟灯：capture→asr→llm→tts→play→e2e 移动平均。

---

## 3) 微信小程序（MP）
- **P0** 登录：`wx.login → /auth/wechat/miniprogram/login → JWT`。
- **P0** 上行：`RecorderManager.onFrameRecorded` 16k PCM 帧化 + WS 重连。
- **P0** 播放：A WebAudio 拼接；B InnerAudio 分片 URL 兜底。
- **P1** 事件卡片与字幕同步；Agent 进度可视化。
- **P2** 域名/CDN 自检与体验版/生产版切换脚本。

---

## 4) 后端网关（Go / Gin）
### 4.1 API（统一前缀 `/api/v1`）
- **P0** `POST /chat/stream`（SSE）：Envelope 输出，事件 `delta/refs/done`。
- **P0** `POST /chat/cancel`：幂等取消，级联到 LLM/TTS。
- **P0** `WS /voice/stream`：`start/audio/stop/cancel` ↔ `asr_partial/final/llm_delta/tts_chunk/...`。
- **P1** `GET /search`、`POST /ingest/upload`、`GET /ingest/tasks/:id`。
- **P1** `GET /agent/stream`（SSE）。

### 4.2 连接与治理
- **P0** SSE/WS 公共封装（`StreamWriter` 抽象）、统一 Envelope（`meta+data+error`）。
- **P0** 心跳/背压：基于队列水位与 CPU 使用率下发 `throttle`。
- **P0** 鉴权与多租户：JWT/OIDC/WeChat；`X-Tenant-ID`。
- **P1** 速率限制/配额：租户/用户/通道维度。

### 4.3 可观测
- **P0** 指标：`ws_active_conns`、`sse_active_streams`、`ingress/egress_audio_bytes`、`barge_in_total`、`throttle_total`。
- **P0** Trace：`voice/ws_read`、`retrieval/search`、`llm/stream`、`tts/first|stream`。

---

## 5) 算法服务（Python / FastAPI / LangChain + LangGraph）
### 5.1 Agent（LangGraph）与 Tools（LangChain）
- **P0** 图编排：`Intent → (Retrieve) → Plan → ToolExec → Synthesize → TTS`（检查点/回放）。
- **P0** 事件流：`agent_plan/step/tool_result/summary`。
- **P0** 只读工具：`fetch_url`、`fs_read`、`github_read`（JSONSchema 校验 + 审计）。
- **P1** 安全策略：工具白名单、越权拒绝、敏感操作二次确认。

### 5.2 RAG（BGE Embedding + FAISS）
- **P0** 嵌入：BGE（`bge-large-zh-v1.5` 或 `bge-m3`），Instruction 前缀，normalize=True。
- **P0** FAISS：`HNSW32,Flat`（`efConstruction=200`；查询 `efSearch=64`）。
- **P0** 检索：TopK=5，返回 `{content, score, source, id}`；Recall@5 ≥ 0.85（验收集）。
- **P1** 入库/建索引：生成 `index.faiss + meta.json`（租户/数据集分片，热重载）。
- **P2** 混合检索/重排（MMR、稀疏+稠密、多向量）。

### 5.3 语音链路（ASR/TTS 适配器）
- **P0** ASR：partial/final 回调；VAD/端点参数（静默阈值、最短发声、回填时长）。
- **P0** TTS：分片合成（200–400ms/块），可取消；首音 < 500ms。
- **P1** 异常回退：ASR/TTS 失败转文本兜底。

### 5.4 服务端接口（FastAPI）
- **P0** `POST /algo/v1/query/stream`（SSE）。
- **P0** `WS /algo/v1/voice/stream`。
- **P1** `POST /algo/v1/retrieve`、`POST /algo/v1/ingest`、`GET /algo/v1/agent/stream`。
- **P1** `/reload?dataset_id=...` 热重载。

### 5.5 算法侧指标
- **P0** `retrieval_latency_seconds`、`faiss_index_load_seconds`、`embed_batch_seconds`。
- **P0** `asr_final_latency_seconds`、`tts_first_audio_seconds`、`agent_node_duration_seconds{node}`。

---

## 6) 安全与多租户
- **P0** JWT/OIDC/WeChat；工具调用短期令牌（60–180s）。
- **P0** 多租户隔离：请求头透传、索引/数据集分片、PG 审计表。
- **P0** 日志脱敏：屏蔽 Token/PII；操作审计可导出。
- **P1** 内容安全：Prompt 注入防护与越权检索检测。

---

## 7) 可观测与告警（Prometheus / Grafana / OTel）
- **P0** 端到端漏斗：`capture → asr → llm → tts → play → e2e`。
- **P0** 语音稳定：`ws_ooo_frames`、`ws_drop_frames`、`jitter_ms_p95`、`mp_ws_disconnects_total`。
- **P0** 告警阈值：语音首响 P95>0.7s、barge-in P95>0.15s、断连异常、RAG 错误率>1%。

---

## 8) DevOps 与环境
- **P0** 本地一键起：`docker-compose`（FAISS/PG/Redis/MinIO + 网关/算法/前端）。
- **P0** Helm/K8s：HPA/PDB/Ingress(wss)，金丝雀发布。
- **P0** 回滚：`helm rollback`；Feature Flags：`VOICE_MP`、`MCP_WRITE`、`AGENT_EVENTS_UI`。
- **P1** 配置与密钥治理：ConfigMap/Secret/KMS/ExternalSecrets。

---

## 9) 测试与质量门禁
- **P0** 单测覆盖：Py ≥70%、Go ≥65%、TS ≥70%。
- **P0** 契约：OpenAPI + WS/SSE 回放；JSON Schema 校验。
- **P0** E2E：Playwright（文本/语音/打断/弱网）。
- **P0** 性能：k6 文本/语音混合；阈值：文本 P95<2.8s、语音首响<700ms、错误率<1%。
- **P1** 失败注入：ASR/TTS/索引缺失/速率限制。

---

## 10) Dify 工作流（可选）
- **P1** 导入 `dify_workflow.yml`（HTTP RAG + LLM），切换豆包与 `RAG_ENDPOINT`。
- **P2** 增加 ASR/TTS 节点或插件，沿用统一契约。

---

## 11) 版本路线图（与本清单映射）
- **v1.0（MVP）**：涵盖所有 **P0** 项。
- **v1.1**：补齐 **P1**（弱网/背压、知识库管理、热重载、更多 API、运营看板）。
- **v1.2+**：**P2**（混合检索/重排、WebRTC、工具写操作灰度、成本优化）。

---

> 本清单与先前输出的《最新设计方案（接口完善版）》、`TODO.md`、`BRANCHING.md`、`TESTPLAN.md` 与 `dify_workflow.yml` 保持一致，可直接导入需求系统或拆分 Issues 执行。
