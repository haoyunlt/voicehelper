{
  "metadata": {
    "name": "API集成测试数据集",
    "version": "1.0.0",
    "description": "用于API测试、第三方服务集成和端到端测试的数据集",
    "created_at": "2025-01-21",
    "test_types": ["api_functional", "third_party_integration", "end_to_end", "contract_testing"],
    "environments": ["development", "staging", "production"]
  },
  "api_functional_tests": [
    {
      "id": "api_001",
      "name": "创建对话",
      "endpoint": "/api/v1/conversations",
      "method": "POST",
      "headers": {
        "Content-Type": "application/json",
        "Authorization": "Bearer {{access_token}}"
      },
      "request_body": {
        "user_id": "test_user_001",
        "channel": "web",
        "context": {
          "user_agent": "Mozilla/5.0",
          "ip_address": "192.168.1.100"
        }
      },
      "expected_response": {
        "status": 201,
        "schema": {
          "type": "object",
          "properties": {
            "conversation_id": {"type": "string"},
            "status": {"type": "string", "enum": ["active"]},
            "created_at": {"type": "string", "format": "date-time"}
          },
          "required": ["conversation_id", "status", "created_at"]
        }
      },
      "assertions": [
        "response.status == 201",
        "response.body.conversation_id != null",
        "response.body.status == 'active'"
      ]
    },
    {
      "id": "api_002",
      "name": "发送消息",
      "endpoint": "/api/v1/conversations/{{conversation_id}}/messages",
      "method": "POST",
      "dependencies": ["api_001"],
      "request_body": {
        "message": "你好，我想了解产品功能",
        "message_type": "text",
        "metadata": {
          "timestamp": "{{current_timestamp}}",
          "client_version": "1.0.0"
        }
      },
      "expected_response": {
        "status": 200,
        "schema": {
          "type": "object",
          "properties": {
            "message_id": {"type": "string"},
            "response": {"type": "string"},
            "intent": {"type": "string"},
            "confidence": {"type": "number", "minimum": 0, "maximum": 1}
          }
        }
      },
      "performance_requirements": {
        "response_time": "<2000ms",
        "timeout": "10s"
      }
    },
    {
      "id": "api_003",
      "name": "获取对话历史",
      "endpoint": "/api/v1/conversations/{{conversation_id}}/messages",
      "method": "GET",
      "query_params": {
        "limit": 20,
        "offset": 0,
        "order": "desc"
      },
      "expected_response": {
        "status": 200,
        "schema": {
          "type": "object",
          "properties": {
            "messages": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "message_id": {"type": "string"},
                  "content": {"type": "string"},
                  "sender": {"type": "string"},
                  "created_at": {"type": "string"}
                }
              }
            },
            "total": {"type": "integer"},
            "has_more": {"type": "boolean"}
          }
        }
      }
    }
  ],
  "third_party_integration_tests": [
    {
      "id": "integration_001",
      "name": "Doubao LLM集成",
      "service": "doubao_llm",
      "endpoint": "https://ark.cn-beijing.volces.com/api/v3/chat/completions",
      "test_scenarios": [
        {
          "scenario": "正常对话",
          "request": {
            "model": "ep-20241221184454-zzqvx",
            "messages": [
              {"role": "user", "content": "你好，请介绍一下自己"}
            ]
          },
          "expected_response": {
            "status": 200,
            "contains": ["choices", "usage"],
            "response_time": "<3000ms"
          }
        },
        {
          "scenario": "流式响应",
          "request": {
            "model": "ep-20241221184454-zzqvx",
            "messages": [
              {"role": "user", "content": "请详细解释人工智能的发展历程"}
            ],
            "stream": true
          },
          "expected_response": {
            "status": 200,
            "content_type": "text/event-stream",
            "stream_events": ">5"
          }
        }
      ]
    },
    {
      "id": "integration_002",
      "name": "Milvus向量数据库集成",
      "service": "milvus",
      "test_scenarios": [
        {
          "scenario": "向量插入",
          "operation": "insert",
          "collection": "knowledge_base",
          "data": {
            "vectors": [[0.1, 0.2, 0.3, 0.4]],
            "metadata": [{"doc_id": "test_001", "content": "测试文档"}]
          },
          "expected_result": "success"
        },
        {
          "scenario": "向量搜索",
          "operation": "search",
          "collection": "knowledge_base",
          "query_vector": [0.1, 0.2, 0.3, 0.4],
          "top_k": 5,
          "expected_result": {
            "results_count": "<=5",
            "similarity_scores": ">0.0"
          }
        }
      ]
    },
    {
      "id": "integration_003",
      "name": "微信小程序集成",
      "service": "wechat_miniprogram",
      "test_scenarios": [
        {
          "scenario": "用户登录",
          "api": "wx.login",
          "mock_response": {
            "code": "test_auth_code_123"
          },
          "backend_verification": {
            "endpoint": "/api/v1/auth/wechat",
            "expected_user_info": {
              "openid": "test_openid",
              "session_key": "test_session_key"
            }
          }
        }
      ]
    }
  ],
  "end_to_end_tests": [
    {
      "id": "e2e_001",
      "name": "完整对话流程",
      "description": "从用户登录到完成对话的完整流程",
      "steps": [
        {
          "step": 1,
          "action": "用户登录",
          "endpoint": "/api/v1/auth/login",
          "method": "POST",
          "data": {
            "username": "test_user",
            "password": "test_password"
          },
          "store_variables": {
            "access_token": "response.access_token"
          }
        },
        {
          "step": 2,
          "action": "创建对话",
          "endpoint": "/api/v1/conversations",
          "method": "POST",
          "headers": {
            "Authorization": "Bearer {{access_token}}"
          },
          "data": {
            "user_id": "test_user",
            "channel": "web"
          },
          "store_variables": {
            "conversation_id": "response.conversation_id"
          }
        },
        {
          "step": 3,
          "action": "发送消息",
          "endpoint": "/api/v1/conversations/{{conversation_id}}/messages",
          "method": "POST",
          "data": {
            "message": "你好，我想了解产品价格"
          },
          "assertions": [
            "response.status == 200",
            "response.body.response != null",
            "response.body.intent == 'pricing_inquiry'"
          ]
        },
        {
          "step": 4,
          "action": "继续对话",
          "endpoint": "/api/v1/conversations/{{conversation_id}}/messages",
          "method": "POST",
          "data": {
            "message": "企业版的价格是多少？"
          },
          "assertions": [
            "response.status == 200",
            "response.body.response contains '企业版'"
          ]
        },
        {
          "step": 5,
          "action": "获取对话历史",
          "endpoint": "/api/v1/conversations/{{conversation_id}}/messages",
          "method": "GET",
          "assertions": [
            "response.status == 200",
            "response.body.messages.length >= 4"
          ]
        }
      ],
      "cleanup": [
        {
          "action": "删除测试对话",
          "endpoint": "/api/v1/conversations/{{conversation_id}}",
          "method": "DELETE"
        }
      ]
    },
    {
      "id": "e2e_002",
      "name": "语音对话流程",
      "description": "语音输入到语音输出的完整流程",
      "steps": [
        {
          "step": 1,
          "action": "上传语音文件",
          "endpoint": "/api/v1/voice/upload",
          "method": "POST",
          "content_type": "multipart/form-data",
          "files": {
            "audio": "test_audio.wav"
          },
          "store_variables": {
            "audio_id": "response.audio_id"
          }
        },
        {
          "step": 2,
          "action": "语音识别",
          "endpoint": "/api/v1/voice/asr",
          "method": "POST",
          "data": {
            "audio_id": "{{audio_id}}"
          },
          "assertions": [
            "response.status == 200",
            "response.body.transcript != null"
          ],
          "store_variables": {
            "transcript": "response.body.transcript"
          }
        },
        {
          "step": 3,
          "action": "处理对话",
          "endpoint": "/api/v1/chat/process",
          "method": "POST",
          "data": {
            "message": "{{transcript}}",
            "response_format": "audio"
          },
          "assertions": [
            "response.status == 200",
            "response.body.audio_url != null"
          ]
        }
      ]
    }
  ],
  "contract_testing": [
    {
      "id": "contract_001",
      "name": "API契约验证",
      "provider": "chatbot_api",
      "consumer": "web_frontend",
      "pact_file": "web_frontend-chatbot_api.json",
      "interactions": [
        {
          "description": "获取用户对话列表",
          "request": {
            "method": "GET",
            "path": "/api/v1/users/{{user_id}}/conversations",
            "headers": {
              "Authorization": "Bearer {{token}}"
            }
          },
          "response": {
            "status": 200,
            "headers": {
              "Content-Type": "application/json"
            },
            "body": {
              "conversations": [
                {
                  "id": "conv_123",
                  "title": "产品咨询",
                  "created_at": "2025-01-21T10:00:00Z"
                }
              ]
            }
          }
        }
      ]
    }
  ],
  "error_handling_tests": [
    {
      "id": "error_001",
      "name": "无效认证令牌",
      "endpoint": "/api/v1/conversations",
      "method": "POST",
      "headers": {
        "Authorization": "Bearer invalid_token"
      },
      "expected_response": {
        "status": 401,
        "body": {
          "error": "unauthorized",
          "message": "Invalid or expired token"
        }
      }
    },
    {
      "id": "error_002",
      "name": "请求参数验证",
      "endpoint": "/api/v1/conversations",
      "method": "POST",
      "request_body": {
        "user_id": "",
        "channel": "invalid_channel"
      },
      "expected_response": {
        "status": 400,
        "body": {
          "error": "validation_error",
          "details": [
            {"field": "user_id", "message": "required"},
            {"field": "channel", "message": "invalid value"}
          ]
        }
      }
    }
  ],
  "performance_integration_tests": [
    {
      "id": "perf_int_001",
      "name": "API响应时间测试",
      "endpoints": [
        {
          "path": "/api/v1/conversations",
          "method": "POST",
          "target_time": "200ms"
        },
        {
          "path": "/api/v1/chat/send",
          "method": "POST",
          "target_time": "2000ms"
        },
        {
          "path": "/api/v1/voice/asr",
          "method": "POST",
          "target_time": "500ms"
        }
      ],
      "concurrent_users": 10,
      "duration": "5m"
    }
  ],
  "data_consistency_tests": [
    {
      "id": "consistency_001",
      "name": "对话数据一致性",
      "scenario": "验证对话在不同服务间的数据一致性",
      "steps": [
        {
          "action": "创建对话",
          "service": "chat_service",
          "store": "conversation_data"
        },
        {
          "action": "验证数据库记录",
          "service": "database",
          "verify": "conversation_data matches database record"
        },
        {
          "action": "验证缓存数据",
          "service": "redis",
          "verify": "conversation_data matches cache"
        }
      ]
    }
  ],
  "test_environment_config": {
    "development": {
      "base_url": "http://localhost:8080",
      "database": "chatbot_dev",
      "redis": "localhost:6379",
      "milvus": "localhost:19530"
    },
    "staging": {
      "base_url": "https://staging-api.chatbot.com",
      "database": "chatbot_staging",
      "redis": "staging-redis:6379",
      "milvus": "staging-milvus:19530"
    },
    "production": {
      "base_url": "https://api.chatbot.com",
      "database": "chatbot_prod",
      "redis": "prod-redis:6379",
      "milvus": "prod-milvus:19530"
    }
  },
  "test_data_management": {
    "setup_data": [
      {
        "entity": "test_users",
        "count": 10,
        "template": {
          "user_id": "test_user_{{index}}",
          "email": "test{{index}}@example.com",
          "role": "user"
        }
      },
      {
        "entity": "test_conversations",
        "count": 20,
        "template": {
          "conversation_id": "test_conv_{{index}}",
          "user_id": "test_user_{{random(1,10)}}",
          "status": "active"
        }
      }
    ],
    "cleanup_data": [
      "DELETE FROM conversations WHERE conversation_id LIKE 'test_conv_%'",
      "DELETE FROM users WHERE user_id LIKE 'test_user_%'"
    ]
  },
  "monitoring_and_alerting": {
    "test_metrics": [
      "test_execution_time",
      "test_success_rate",
      "api_response_time",
      "error_rate"
    ],
    "alerts": [
      {
        "condition": "test_success_rate < 95%",
        "action": "notify_team"
      },
      {
        "condition": "api_response_time > 5000ms",
        "action": "escalate_to_ops"
      }
    ]
  }
}
